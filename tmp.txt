<?php
require_once __DIR__ . '/../../controllers/auth.php';
auth_require_login('/redmine/login.php');
require_once __DIR__ . '/../../controllers/dashboard.php';

// Cargar grupos de horas extra (agrupados por fecha)
$selMes = isset($_GET["mes"]) ? trim($_GET["mes"]) : "";
$selAnio = isset($_GET["anio"]) ? trim($_GET["anio"]) : "";
$grupos = load_hours_extra_all();
$h = fn($v) => htmlspecialchars($v ?? '', ENT_QUOTES, 'UTF-8');
$activeNav = 'horas';
setlocale(LC_TIME, 'es_CL.UTF-8', 'es_ES.UTF-8', 'es_ES', 'Spanish');

$flash = null;

function normalize_date_key($fecha) {
    $fecha = trim((string)$fecha);
    if ($fecha === '') return '';
    $fmts = ['Y-m-d', 'd-m-Y', 'd/m/Y', 'Y/m/d'];
    foreach ($fmts as $f) {
        $dt = DateTime::createFromFormat($f, $fecha);
        if ($dt instanceof DateTime) {
            return $dt->format('Y-m-d');
        }
    }
    return $fecha;
}

// Actualiza horas de inicio/fin para un grupo dado por fecha
function update_hours_by_date($fecha, $horaIni, $horaFin) {
    if ($fecha === '') return false;
    $fechaKey = normalize_date_key($fecha);
    $horaIni = sanitize_time_value($horaIni);
    $horaFin = sanitize_time_value($horaFin);
    $updated = false;
    $years = glob(HOURS_EXTRA_DIR . '/*', GLOB_ONLYDIR);
    foreach ($years as $yearDir) {
        $files = glob($yearDir . '/*.json');
        foreach ($files as $file) {
            $data = json_decode(file_get_contents($file), true);
            if (!is_array($data)) continue;
            // convertir legacy (lista plana) a grupos
            if (!isset($data[0]['reports'])) {
                $tmp = [];
                foreach ($data as $row) {
                    if (!is_array($row)) continue;
                    $fb = $row['fecha_inicio'] ?? ($row['fecha'] ?? '');
                    $fbKey = normalize_date_key($fb);
                    if ($fbKey === '') continue;
                    $key = $fbKey;
                    if (!isset($tmp[$key])) {
                        $tmp[$key] = [
                            'fecha' => $fbKey,
                            'hora_inicio' => $row['hora'] ?? '',
                            'hora_fin' => $row['fecha_fin'] ?? '',
                            'reports' => [],
                        ];
                    }
                    $tmp[$key]['reports'][] = $row;
                }
                $data = array_values($tmp);
            }
            $changed = false;
            foreach ($data as &$g) {
                $gKey = normalize_date_key($g['fecha'] ?? '');
                if (!is_array($g) || $gKey !== $fechaKey) continue;
                if ($horaIni !== '') { $g['hora_inicio'] = $horaIni; $changed = true; }
                if ($horaFin !== '') { $g['hora_fin'] = $horaFin; $changed = true; }
            }
            unset($g);
            if ($changed) {
                file_put_contents($file, json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
                $updated = true;
            }
        }
    }
    return $updated;
}
if ($_SERVER['REQUEST_METHOD'] === 'POST' && ($_POST['action'] ?? '') === 'update_extra') {
    $fecha = trim($_POST['fecha'] ?? '');
    $horaIni = trim($_POST['hora_ini'] ?? '');
    $horaFin = trim($_POST['hora_fin'] ?? '');
    if (update_hours_by_date($fecha, $horaIni, $horaFin)) {
        $flash = 'Horas actualizadas';
    } else {
        $flash = 'No se encontraron registros para esa fecha';
    }
    $grupos = load_hours_extra_all();
    // Si se envió fecha y no hay filtros, fijar mes/año para mostrar el grupo editado
    if ($fecha !== '' && $selMes === '' && $selAnio === '') {
        $dtTmp = DateTime::createFromFormat('Y-m-d', $fecha) ?: DateTime::createFromFormat('d-m-Y', $fecha);
        if ($dtTmp instanceof DateTime) {
            $selMes = $dtTmp->format('n');
            $selAnio = $dtTmp->format('Y');
        }
    }
}

// AÃ±os disponibles
$aniosDisponibles = [];
foreach ($grupos as $g) {
    $fechaBase = $g['fecha'] ?? '';
    if ($fechaBase) {
        $dt = DateTime::createFromFormat('Y-m-d', $fechaBase) ?: DateTime::createFromFormat('d-m-Y', $fechaBase);
        if ($dt instanceof DateTime) {
            $aniosDisponibles[$dt->format('Y')] = true;
        }
    }
}
$aniosDisponibles = array_keys($aniosDisponibles);
sort($aniosDisponibles);

// Filtrar por mes/aÃ±o
$grupos = array_values(array_filter($grupos, function($g) use ($selMes, $selAnio) {
    $fechaBase = $g['fecha'] ?? '';
    if ($fechaBase) {
        $dt = DateTime::createFromFormat('Y-m-d', $fechaBase) ?: DateTime::createFromFormat('d-m-Y', $fechaBase);
        if ($dt instanceof DateTime) {
            $mesNum = (int)$dt->format('n');
            $anioNum = $dt->format('Y');
            if ($selMes !== '' && (int)$selMes !== $mesNum) return false;
            if ($selAnio !== '' && $selAnio !== $anioNum) return false;
        }
    }
    return true;
}));

?>
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Horas extra</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/redmine/assets/theme.css" rel="stylesheet">
</head>
<body class="bg-light">
<?php include __DIR__ . '/../partials/navbar.php'; ?>

<div class="container-fluid py-4">
  <div class="d-flex align-items-center gap-2 mb-3">
    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-inline-flex align-items-center justify-content-center" style="width:44px;height:44px;">
      <i class="bi bi-alarm"></i>
    </div>
    <div>
      <h2 class="mb-0">Horas extra</h2>
      <div class="text-muted">Mensajes procesados con Hora Extra = SI (agrupados por fecha)</div>
    </div>
  </div>

  <form class="card shadow-sm mb-3" method="get">
    <div class="card-body row g-3 align-items-end">
      <div class="col-md-4 col-lg-3">
        <label class="form-label">Mes</label>
        <select name="mes" class="form-select">
          <option value="">Todos</option>
          <?php
            $meses = [
              1=>'enero',2=>'febrero',3=>'marzo',4=>'abril',5=>'mayo',6=>'junio',
              7=>'julio',8=>'agosto',9=>'septiembre',10=>'octubre',11=>'noviembre',12=>'diciembre'
            ];
            foreach ($meses as $k=>$v):
          ?>
            <option value="<?= $k ?>" <?= ($selMes !== '' && (int)$selMes === $k) ? 'selected' : '' ?>><?= ucwords($v) ?></option>
          <?php endforeach; ?>
        </select>
      </div>
      <div class="col-md-4 col-lg-3">
        <label class="form-label">AÃ±o</label>
        <select name="anio" class="form-select">
          <option value="">Todos</option>
          <?php foreach ($aniosDisponibles as $an): ?>
            <option value="<?= $h($an) ?>" <?= ($selAnio !== '' && $selAnio === $an) ? 'selected' : '' ?>><?= $h($an) ?></option>
                <th>Fecha</th>
                <th>Detalle</th>
                <th>N° Ticket</th>
                <th>Mes</th>
                <th>Día</th>
                <th>Año</th>
      </div>
    </div>
  </form>

  <?php if ($flash): ?>
    <div class="alert alert-success"><?= $h($flash) ?></div>
  <?php endif; ?>

  <div class="card shadow-sm">
    <div class="card-body">
      <?php if (empty($grupos)): ?>
        <div class="text-muted">No hay registros de horas extra.</div>
      <?php else: ?>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>Detalle</th>
                <th>NÂ° Ticket</th>
                <th>Mes</th>
                <th>DÃ­a</th>
                <th>AÃ±o</th>
              </tr>
            </thead>
            <tbody>
              <?php foreach ($grupos as $grp): ?>
                <?php
                  $fechaBase = $grp['fecha'] ?? '';
                  $fechaIso = $fechaBase;
                  $fechaMostrar = $fechaBase;
                  $mes = $dia = $anio = '';
                  if ($fechaBase) {
                      $dt = DateTime::createFromFormat('Y-m-d', $fechaBase) ?: DateTime::createFromFormat('d-m-Y', $fechaBase);
                      if ($dt instanceof DateTime) {
                          $fechaIso = $dt->format('Y-m-d');
                          $fechaMostrar = $dt->format('d-m-Y');
                          $mes = ucwords(strftime('%B', $dt->getTimestamp()));
                          $dia = ucwords(strftime('%A', $dt->getTimestamp()));
                          $anio = $dt->format('Y');
                      }
                  }
                  $horaIni = $grp['hora_inicio'] ?? '';
                  $horaFin = $grp['hora_fin'] ?? '';
                  $reports = is_array($grp['reports'] ?? null) ? $grp['reports'] : [];
                  $horaIniClean = $horaIni ? substr($horaIni, 0, 5) : '';
                  $horaFinClean = $horaFin ? substr($horaFin, 0, 5) : '';
                ?>
                <tr class="table-secondary">
                  <td colspan="6">
                    <div class="d-flex justify-content-between align-items-center w-100">
                      <span><strong><?= $h($fechaMostrar) ?></strong> · Hora inicio: <?= $h($horaIni) ?> | Hora término: <?= $h($horaFin) ?></span>
                      <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal"
                        data-fecha="<?= $h($fechaIso) ?>"
                        data-horaini="<?= $h($horaIniClean) ?>"
                        data-horafin="<?= $h($horaFinClean) ?>"
                      ><i class="bi bi-pencil-square"></i> Editar horas</button>
                    </div>
                  </td>
                </tr>
                <?php foreach ($reports as $m): ?>
                  <?php
                    $detalle = $m['asunto'] ?? '';
                    $ticket = $m['redmine_id'] ?? '';
                  ?>
                  <tr>
                    <td><?= $h($fechaMostrar) ?></td>
                    <td><?= $h($detalle) ?></td>
                    <td><?= $h($ticket) ?></td>
                    <td><?= $h($mes) ?></td>
                    <td><?= $h($dia) ?></td>
                    <td><?= $h($anio) ?></td>
                  </tr>
                <?php endforeach; ?>
            <label class="form-label">Hora de término</label>
            </tbody>
          </table>
        </div>
      <?php endif; ?>
    </div>
  </div>
</div>

<!-- Modal editar -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        <input type="hidden" name="action" value="update_extra">
        <div class="modal-header">
          <h5 class="modal-title">Editar horas por fecha</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Fecha</label>
            <input type="date" class="form-control" name="fecha" id="md-fecha" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Hora de inicio</label>
            <input type="time" class="form-control" name="hora_ini" id="md-hora-ini" step="60">
          </div>
          <div class="mb-3">
            <label class="form-label">Hora de término</label>
            <input type="time" class="form-control" name="hora_fin" id="md-hora-fin" step="60">
          </div>
          <p class="text-muted small mb-0">Las horas se aplican a todos los reportes de esa fecha.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const editModal = document.getElementById('editModal');
if (editModal) {
  editModal.addEventListener('show.bs.modal', ev => {
    const btn = ev.relatedTarget;
    if (!btn) return;
    const setVal = (id, attr) => {
      const el = document.getElementById(id);
      if (el) el.value = btn.getAttribute(attr) || '';
    };
    setVal('md-fecha', 'data-fecha');
    setVal('md-hora-ini', 'data-horaini');
    setVal('md-hora-fin', 'data-horafin');
  });
}
</script>
</body>
</html>







